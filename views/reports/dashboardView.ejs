<%- include('../includes/header') %>
    <title>Dashboard</title>
</head>
<body>
    <div class="main-container">
        <%- include('../includes/sideNav') %>

        <div class="content-container dashboard-container">
            <div class="dashboard-header">
                <h1>Dashboard</h1>
                <select id="branchDropdown">
                    <option value="all">All Branches</option>
                    
                </select>
            </div>
            <div class="reports-container">
                <div class="report-box">
                    <h2><i class="fa-solid fa-user-group"></i> Total Members: <b id="totalMembersCount">0</b></h2>
                    <div id="totalMembersChartContainer">
                        <canvas id="totalMembersChart" width="320" height="200"></canvas>
                    </div>
                </div>
                <div class="report-box">
                    <h2><i class="fa-solid fa-user-group"></i> Total Active Members: <b id="totalActiveMembersCount">0</b></h2>
                    <div id="totalMembersChartContainer">
                        <canvas id="totalActiveMembersChart" width="320" height="200"></canvas>
                    </div>
                </div>
                <div class="report-box">
                    <h2><i class="fa-solid fa-user-group"></i> Total Inactive Members: <b id="totalInactiveMembersCount">0</b></h2>
                    <div id="totalMembersChartContainer">
                        <canvas id="totalInactiveMembersChart" width="320" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="reports-container">
                <a href="/reports/neverSubscribed/<%= branchName %>?branch=<%= branchName %>" class="report-box special-box">
                    <h2><i class="fa-solid fa-user-xmark"></i> Never Subscribed</h2>
                    <div class="round-shape" id="totalNeverSubscribedCount">0</div>
                </a>
                <div class="report-box">
                    <div id="genderRatioBox">
                        <h2><i class="fa-solid fa-venus-mars"></i> Gender: <b id="maleCount">0</b> Males / <b id="femaleCount">0</b> Females</h2>
                        <canvas id="genderRatioChart" width="320" height="200"></canvas>
                    </div>
                </div>
                <div class="report-box">
                    <h2><i class="fa-solid fa-map-location-dot"></i> Residential Areas</h2>
                    <canvas id="residentialAreasChart" width="320" height="200"></canvas>
                </div>
            </div>
            <div class="filters-container">
                <select id="yearDropdown">
                    
                </select>
                <select name="" id="monthDropdown">
                    <option value="Jan">January</option>
                    <option value="Feb">February</option>
                    <option value="Mar">March</option>
                    <option value="Apr">April</option>
                    <option value="May">May</option>
                    <option value="Jun">June</option>
                    <option value="Jul">July</option>
                    <option value="Aug">August</option>
                    <option value="Sep">September</option>
                    <option value="Oct">October</option>
                    <option value="Nov">November</option>
                    <option value="Dec">December</option>
                </select>
            </div>
            <div class="reports-container">
                <div class="report-box">
                    <h2><i class="fa-solid fa-wallet"></i> Total Sales <b id="totalIncome">0</b></h2>
                    <canvas id="totalIncomeChart" width="500" height="300"></canvas>
                </div>
                <div class="report-box">
                    <h2><i class="fa-solid fa-medal"></i> Traffic Chart</h2>
                    <canvas id="attendanceChart" width="500" height="300"></canvas>
                </div>
            </div>
            <div class="reports-container">
                <div class="report-box">
                    <h2><i class="fa-solid fa-medal"></i> Packages Schemes</h2>
                    <canvas id="bestSellingPackagesChart" width="800" height="350"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>

    <script>
        $(document).ready(function () {

                // Function to fetch available branches
                function getAvailableBranches() {
                    return new Promise((resolve, reject) => {
                        $.ajax({
                            url: '/reports/dashboard/all/availableBranches',
                            method: 'GET',
                            success: function (data) {
                                resolve(data);
                            },
                            error: function (error) {
                                reject(error);
                            }
                        });
                    });
                }

                // Function to populate the branch dropdown dynamically
                function populateBranchDropdown() {
                    getAvailableBranches()
                        .then(data => {
                            const branchDropdown = $('#branchDropdown');
                            
                            // Clear existing options
                            branchDropdown.empty();

                            // Add the default "All Branches" option
                            branchDropdown.append($('<option>', {
                                value: 'all',
                                text: 'All Branches'
                            }));

                            // Populate the dropdown with available branches
                            data.forEach(branchObj => {
                                // Extract the branch name from each object
                                const branch = branchObj.branch_name;
                                branchDropdown.append($('<option>', {
                                    value: branch,
                                    text: branch
                                }));
                            });
                        })
                        .catch(error => console.error('Error fetching available branches:', error));
                }

                // Call the function to populate the branch dropdown on page load
                populateBranchDropdown();


                // Initial fetch and render with the default branch
                const defaultBranch = 'all';
                getTotalMembersByBranch(defaultBranch);

                // Handle branch selection change
                $('#branchDropdown').on('change', function () {
                    const selectedBranch = $(this).val();
                    getTotalMembersByBranch(selectedBranch);
                });
            
            //////////////////////////////////////////////////////////////////////////

            // Function to fetch all avaliable years based on the selected branch
            function getAvailableYears(branch) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: `/reports/dashboard/${branch}/availableYears?branch=${branch}`,
                        method: 'GET',
                        success: function (data) {
                            resolve(data);
                        },
                        error: function (error) {
                            reject(error);
                        }
                    });
                });
            }

            // Function to populate the year dropdown dynamically
            function populateYearDropdown(branch) {
                getAvailableYears(branch)
                    .then(data => {
                        const yearDropdown = $('#yearDropdown');
                        // Extract unique years and sort them in descending order
                        const uniqueYears = [...new Set(data.map(entry => entry.year))].sort((a, b) => b - a);

                        // Clear existing options
                        yearDropdown.empty();

                        // Populate the dropdown with unique years
                        uniqueYears.forEach(year => {
                            yearDropdown.append($('<option>', {
                                value: year,
                                text: year
                            }));
                        });
                    })
                    .catch(error => console.error('Error fetching available years:', error));
            }

            // Call the function to populate the year dropdown on page load
            populateYearDropdown(defaultBranch);

             // Get the current month and year dynamically
            const currentDate = new Date();
            const monthAbbreviations = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const defaultMonth = monthAbbreviations[currentDate.getMonth()]; // Months are 0-indexed
            const defaultYear = currentDate.getFullYear();

            ////////////////////////// Total Members /////////////////////////////////

            // Function to fetch total members based on the selected branch
            function getTotalMembersByBranch(branch) {
                $.ajax({
                    url: `/reports/dashboard/${branch}/totalMembers?branch=${branch}`,
                    method: 'GET',
                    success: function (data) {
                        renderTotalMembersChart(data);
                    },
                    error: function (error) {
                        console.error('Error fetching total members:', error);
                    }
                });
            }

            // Function to render the total members chart
            function renderTotalMembersChart(data) {
                if (!Array.isArray(data)) {
                    console.error('Invalid data format. Expected an array.');
                    return;
                }

                const ctx = document.getElementById('totalMembersChart').getContext('2d');

                // If the chart already exists, destroy it
                if (window.totalMembersChart && typeof window.totalMembersChart.destroy === 'function') {
                    window.totalMembersChart.destroy();
                }

                const labels = data.map(entry => entry.branch_name);
                const values = data.map(entry => entry.total_members);

                // Update the total members box
                const totalMembersCount = values.reduce((total, count) => total + parseInt(count), 0);
                $('#totalMembersCount').text(totalMembersCount);

                window.totalMembersChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Members',
                            data: values,
                            backgroundColor: 'rgba(75, 192, 192, 0.8)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Branch'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Total Members'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            ////////////////////////////// Total Active Members /////////////////////////////////

            // Function to fetch total active members with valid packages by branch
            function getTotalActiveMembersByBranch(branch) {
                $.ajax({
                    url: `/reports/dashboard/${branch}/totalActiveMembers?branch=${branch}`,
                    method: 'GET',
                    success: function(data) {
                        renderTotalActiveMembersChart(data);
                    },
                    error: function(error) {
                        console.error('Error fetching total active members with valid packages:', error);
                    }
                });
            }

            // Function to render the total active members chart
            function renderTotalActiveMembersChart(data) {
                if (!Array.isArray(data)) {
                    console.error('Invalid data format. Expected an array.');
                    return;
                }

                const ctx = document.getElementById('totalActiveMembersChart').getContext('2d');

                // If the chart already exists, destroy it
                if (window.totalActiveMembersChart && typeof window.totalActiveMembersChart.destroy === 'function') {
                    window.totalActiveMembersChart.destroy();
                }

                const labels = data.map(entry => entry.branch_name);
                const values = data.map(entry => entry.total_active_members);

                // Update the total active members box
                const totalActiveMembersCount = values.reduce((total, count) => total + parseInt(count), 0);
                $('#totalActiveMembersCount').text(totalActiveMembersCount);

                window.totalActiveMembersChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total Active Members with Valid Packages',
                            data: values,
                            backgroundColor: 'rgba(75, 192, 192, 0.8)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Branch'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Total Active Members with Valid Packages'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Call the function to fetch total active members with valid packages on page load
            $(document).ready(function() {
                const defaultBranch = 'all';
                getTotalActiveMembersByBranch(defaultBranch);
            });

            // Handle branch selection change
            $('#branchDropdown').on('change', function() {
                const selectedBranch = $(this).val();
                getTotalActiveMembersByBranch(selectedBranch);
            });

            ////////////////////////////// Total Inactive Members /////////////////////////////////

            // Function to fetch total active members with valid packages by branch
            function getTotalInactiveMembersByBranch(branch) {
                $.ajax({
                    url: `/reports/dashboard/${branch}/totalInactiveMembers?branch=${branch}`,
                    method: 'GET',
                    success: function(data) {
                        renderTotalInactiveMembersChart(data);
                    },
                    error: function(error) {
                        console.error('Error fetching total inactive members with valid packages:', error);
                    }
                });
            }

            // Function to render the total active members chart
            function renderTotalInactiveMembersChart(data) {
                if (!Array.isArray(data)) {
                    console.error('Invalid data format. Expected an array.');
                    return;
                }

                const ctx = document.getElementById('totalInactiveMembersChart').getContext('2d');

                // If the chart already exists, destroy it
                if (window.totalInactiveMembersChart && typeof window.totalInactiveMembersChart.destroy === 'function') {
                    window.totalInactiveMembersChart.destroy();
                }

                const labels = data.map(entry => entry.branch_name);
                const values = data.map(entry => entry.total_inactive_members);

                // Update the total inactive members box
                const totalInactiveMembersCount = values.reduce((total, count) => total + parseInt(count), 0);
                $('#totalInactiveMembersCount').text(totalInactiveMembersCount);

                window.totalInactiveMembersChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total inactive Members',
                            data: values,
                            backgroundColor: 'rgba(219, 60, 48, 0.8)',
                            borderColor: 'rgba(219, 60, 48, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Branch'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Total Inactive Members with Valid Packages'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Call the function to fetch total active members with valid packages on page load
            $(document).ready(function() {
                const defaultBranch = 'all';
                getTotalInactiveMembersByBranch(defaultBranch);
            });

            // Handle branch selection change
            $('#branchDropdown').on('change', function() {
                const selectedBranch = $(this).val();
                getTotalInactiveMembersByBranch(selectedBranch);
            });


            ////////////////////////////// Total Never Subscribed Before /////////////////////////////////

            // Fetch total number of never subscribed users
            fetch('/reports/dashboard/all/totalNeverSubscribed?branch=all')
                .then(response => response.json())
                .then(data => {
                    // Extract count of never subscribed users
                    const count = data[0].total_never_subscribed_users;

                    // Display the count in an HTML element
                    document.getElementById('totalNeverSubscribedCount').innerText = count;
                })
                .catch(error => console.error('Error fetching total never subscribed users:', error));

            ////////////////////////////// Gender Chart //////////////////////////////////

            // Function to fetch gender data based on the selected branch
            function getGenderDataByBranch(branch) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: `/reports/dashboard/${branch}/genderData?branch=${branch}`,
                        method: 'GET',
                        success: function (data) {
                            resolve(data);
                        },
                        error: function (error) {
                            reject(error);
                        }
                    });
                });
            }
            
            // Function to render the gender chart and update the gender box
            function renderGenderRatioChart(data) {
                if (!Array.isArray(data)) {
                    console.error('Invalid data format. Expected an array.');
                    return;
                }

                // Create or update the chart
                const ctx = document.getElementById('genderRatioChart').getContext('2d');
                // If the chart already exists, destroy it
                if (window.genderRatioChart && typeof window.genderRatioChart.destroy === 'function') {
                    window.genderRatioChart.destroy();
                }

                const labels = data.map(entry => entry.branch_name);
                const maleCounts = data.map(entry => entry.male_count);
                const femaleCounts = data.map(entry => entry.female_count);

                // Update the gender ratio box
                const totalMaleCount = maleCounts.reduce((total, count) => total + parseInt(count), 0);
                const totalFemaleCount = femaleCounts.reduce((total, count) => total + parseInt(count), 0);

                $('#maleCount').text(totalMaleCount);
                $('#femaleCount').text(totalFemaleCount);

                window.genderRatioChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                    labels: labels,
                    datasets: [{
                        label: 'Males',
                        data: maleCounts,
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Females',
                        data: femaleCounts,
                        backgroundColor: 'rgba(255, 99, 132, 0.8)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                    },
                    options: {
                    scales: {
                        x: {
                        title: {
                            display: true,
                            text: 'Branch'
                        }
                        },
                        y: {
                        title: {
                            display: true,
                            text: 'Gender Count'
                        },
                        beginAtZero: true
                        }
                    }
                    }
                });
            }

            // Fetch gender data and render the chart on page load
            // const defaultBranch = 'all';
            getGenderDataByBranch(defaultBranch)
            .then(data => renderGenderRatioChart(data))
            .catch(error => console.error('Error fetching and rendering gender data:', error));

            // Handle branch selection change
            $('#branchDropdown').on('change', function () {
            const selectedBranch = $(this).val();
            getGenderDataByBranch(selectedBranch)
                .then(data => renderGenderRatioChart(data))
                .catch(error => console.error('Error fetching and rendering gender data:', error));
            });


            ///////////////////////// Residential Area ////////////////////////////

            // Function to fetch residential areas data based on the selected branch
            function getResidentialAreasDataByBranch(branch) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: `/reports/dashboard/${branch}/residentialAreasData?branch=${branch}`,
                        method: 'GET',
                        success: function (data) {
                            resolve(data);
                        },
                        error: function (error) {
                            reject(error);
                        }
                    });
                });
            }

            // Function to render the residential areas pie chart
            function renderResidentialAreasChart(data) {
                if (!Array.isArray(data)) {
                    console.error('Invalid data format. Expected an array.');
                    return;
                }

                // Create or update the chart
                const ctx = document.getElementById('residentialAreasChart').getContext('2d');
                // If the chart already exists, destroy it
                if (window.residentialAreasChart && typeof window.residentialAreasChart.destroy === 'function') {
                    window.residentialAreasChart.destroy();
                }

                const labels = data.map(entry => entry.residential_area);
                const counts = data.map(entry => entry.area_count);

                window.residentialAreasChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Residential Areas Count',
                            data: counts,
                            backgroundColor: 'rgba(75, 192, 192, 0.8)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: false,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Residential Area'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Area Count'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Fetch residential areas data and render the chart on page load
            // const defaultBranch = 'all';
            getResidentialAreasDataByBranch(defaultBranch)
                .then(data => renderResidentialAreasChart(data))
                .catch(error => console.error('Error fetching and rendering residential areas data:', error));

            // Handle branch selection change
            $('#branchDropdown').on('change', function () {
                const selectedBranch = $(this).val();
                getResidentialAreasDataByBranch(selectedBranch)
                    .then(data => renderResidentialAreasChart(data))
                    .catch(error => console.error('Error fetching and rendering residential areas data:', error));
            });


            ///////////////////// Best Selling Packages /////////////////////////////

            // Function to fetch best-selling packages data based on the selected branch
            function getBestSellingPackagesData(branch) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: `/reports/dashboard/${branch}/bestSellingPackagesData?branch=${branch}`,
                        method: 'GET',
                        success: function (data) {
                            resolve(data);
                        },
                        error: function (error) {
                            reject(error);
                        }
                    });
                });
            }

            // Function to render the best-selling packages bar chart
            function renderBestSellingPackagesChart(data) {
                if (!Array.isArray(data)) {
                    console.error('Invalid data format. Expected an array.');
                    return;
                }

                // Create or update the chart
                const ctx = document.getElementById('bestSellingPackagesChart').getContext('2d');
                // If the chart already exists, destroy it
                if (window.bestSellingPackagesChart && typeof window.bestSellingPackagesChart.destroy === 'function') {
                    window.bestSellingPackagesChart.destroy();
                }

                const labels = data.map(entry => entry.package_name);
                const packageCounts = data.map(entry => entry.package_count);

                // Find the maximum and minimum package counts
                const maxCount = Math.max(...packageCounts);
                const minCount = Math.min(...packageCounts);

                window.bestSellingPackagesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Package Counts',
                            data: packageCounts,
                            backgroundColor: packageCounts.map(count => (count === maxCount ? 'rgba(0, 0, 0, 0.8)' : count === minCount ? 'rgba(75, 192, 192, 0.8)' : 'rgba(75, 192, 192, 0.8)')),
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: false,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Package'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Package Count'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }


            // Fetch best-selling packages data and render the chart on page load
            getBestSellingPackagesData(defaultBranch)
            .then(data => renderBestSellingPackagesChart(data))
            .catch(error => console.error('Error fetching and rendering best-selling packages data:', error));

            // Handle branch selection change
            $('#branchDropdown').on('change', function () {
                const selectedBranch = $(this).val();
                getBestSellingPackagesData(selectedBranch)
                .then(data => renderBestSellingPackagesChart(data))
                .catch(error => console.error('Error fetching and rendering best-selling packages data:', error));
            });

            /////////////////////// Total Income ///////////////////////////////

            // Function to fetch total income data based on the selected branch, month, and year
            function getTotalIncome(branch, year, month) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: `/reports/dashboard/${branch}/totalIncome?branch=${branch}&year=${year}&month=${month}`,
                        method: 'GET',
                        success: function (data) {
                            resolve(data);
                        },
                        error: function (error) {
                            reject(error);
                        }
                    });
                });
            }

            // Function to display total income in the <p> tag
                function displayTotalIncome(data, year, month) {
                if (!Array.isArray(data)) {
                    console.error('Invalid data format. Expected an array.');
                    return;
                }

                const totalIncome = data.reduce((total, entry) => total + parseFloat(entry.total_income), 0);
                const formattedTotalIncome = totalIncome.toLocaleString('en-US', {
                    style: 'currency',
                    currency: 'EGP',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                });

                $('#totalIncome').text(formattedTotalIncome);
            }

            // Function to render the line chart for total income
            function renderTotalIncomeLineChart(data, year) {
                const monthLabels = data.map(entry => entry.month);
                const lineDatasets = [];

                // Array of colors for branches
                const branchColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];

                // Separate datasets for each branch
                const uniqueBranches = Array.from(new Set(data.map(entry => entry.branch_name)));
                uniqueBranches.forEach((branch, index) => {
                    const branchData = data.filter(entry => entry.branch_name === branch);
                    const branchIncome = branchData.map(entry => parseFloat(entry.total_income));
                    lineDatasets.push({
                        label: branch,
                        data: branchIncome,
                        backgroundColor: branchColors[index],
                        // borderColor: 'rgba(75, 192, 192, 1)',
                        fill: false
                    });
                });

                // Create or update the chart
                const ctx = document.getElementById('totalIncomeChart').getContext('2d');
                let totalIncomeChart = window.TotalIncomeChart;

                // If the chart already exists, destroy it
                if (totalIncomeChart && typeof totalIncomeChart.destroy === 'function') {
                    totalIncomeChart.destroy();
                }

                // Initialize chart data
                const chartData = {
                    labels: monthLabels,
                    datasets: lineDatasets
                };


                // Create the line chart
                window.TotalIncomeChart = new Chart(ctx, {
                    type: 'bar',
                    data: chartData,
                    options: {
                        responsive: false,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Month'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Total Income'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Fetch total income data based on the default branch, year, and month on page load
            getTotalIncome(defaultBranch, defaultYear, defaultMonth)
                .then(data => {
                    renderTotalIncomeLineChart(data);
                    displayTotalIncome(data, defaultYear, defaultMonth);
                })
                .catch(error => console.error('Error fetching and rendering total income data:', error));


            // Handle branch selection change
            $('#branchDropdown').on('change', function () {
                const selectedBranch = $(this).val();
                const selectedYear = $('#yearDropdown').val();
                const selectedMonth = $('#monthDropdown').val();
                getTotalIncome(selectedBranch, selectedYear, selectedMonth)
                    .then(data => {
                        renderTotalIncomeLineChart(data);
                        displayTotalIncome(data, selectedYear, selectedMonth);
                    })
                    .catch(error => console.error('Error fetching and rendering total income data:', error));
            });

            // Handle year selection change
            $('#yearDropdown').on('change', function () {
                const selectedYear = $(this).val();
                const selectedBranch = $('#branchDropdown').val();
                const selectedMonth = $('#monthDropdown').val();
                getTotalIncome(selectedBranch, selectedYear, selectedMonth)
                    .then(data => {
                        renderTotalIncomeLineChart(data);
                        displayTotalIncome(data, selectedYear, selectedMonth);
                    })
                    .catch(error => console.error('Error fetching and rendering total income data:', error));
            });

            // Handle month selection change
            $('#monthDropdown').on('change', function () {
                const selectedMonth = $(this).val();
                const selectedBranch = $('#branchDropdown').val();
                const selectedYear = $('#yearDropdown').val();
                getTotalIncome(selectedBranch, selectedYear, selectedMonth)
                    .then(data => {
                        renderTotalIncomeLineChart(data);
                        displayTotalIncome(data, selectedYear, selectedMonth);
                    })
                    .catch(error => console.error('Error fetching and rendering total income data:', error));
            });


            //////////////  Attendance Chart ///////////

            // Function to get attendance data
            function getAttendanceData(branch, month, year) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: `/reports/dashboard/${branch}/attendanceData?branch=${branch}&month=${month}&year=${year}`,
                        method: 'GET',
                        success: function (data) {
                            resolve(data);
                        },
                        error: function (error) {
                            reject(error);
                        }
                    });
                });
            }

            // Function to display attendance best times chart
            function renderAttendanceChart(data) {
                // Implement rendering logic for the attendance chart using a chart library (e.g., Chart.js)
            }

            // Function to handle attendance chart rendering on page load
            function renderInitialAttendanceChart(branch, defaultMonth, defaultYear) {
                getAttendanceData(branch, defaultMonth, defaultYear)
                    .then(data => renderAttendanceChart(data))
                    .catch(error => console.error('Error fetching and rendering attendance data:', error));
            }

            // Function to display attendance best times chart using Chart.js
            function renderAttendanceChart(data) {

                const ctx = document.getElementById('attendanceChart').getContext('2d');
                
                // Extract data for labels, datasets, etc., based on your data structure
                const formattedTimes = data.map(entry => {
                    const [hours, minutes] = entry.time.split(':');
                    const parsedHours = parseInt(hours, 10);
                    const period = parsedHours >= 12 ? 'PM' : 'AM';
                    const formattedHours = parsedHours % 12 || 12; // Convert 0 to 12 for 12-hour format
                    return `${formattedHours}:${minutes} ${period}`;
                });

                const datasets = [
                    {
                        label: 'Attendance Count',
                        data: data.map(entry => entry.attendance_count),
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        fill: false
                    }
                ];

                const options = {
                    responsive: false,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Attendance Count'
                            },
                            beginAtZero: true
                        }
                    }
                };

                const config = {
                    type: 'line',
                    data: {
                        labels: formattedTimes,
                        datasets: datasets
                    },
                    options: options
                };

                // Create or update the chart
                if (window.AttendanceChart && typeof window.AttendanceChart.destroy === 'function') {
                    window.AttendanceChart.destroy();
                }

                window.AttendanceChart = new Chart(ctx, config);
            }


//             function renderAttendanceChart(data) {
//     console.log('Attendance Data: ', data);

//     const ctx = document.getElementById('attendanceChart').getContext('2d');

//     // Extract data for labels, datasets, etc., based on your data structure
//     const formattedTimes = data.map(entry => {
//         // Assuming entry.time is in the format '2024-02-03 17:45:36.119626'
//         const timestamp = new Date(entry.time.replace(' ', 'T')); // Replace space with 'T' for correct parsing
//         const hours = timestamp.getHours();
//         const minutes = timestamp.getMinutes();
//         const period = hours >= 12 ? 'PM' : 'AM';
//         const formattedHours = hours % 12 || 12; // Convert 0 to 12 for 12-hour format
//         return `${formattedHours}:${minutes < 10 ? '0' : ''}${minutes} ${period}`;
//     });

//     const datasets = [
//         {
//             label: 'Attendance Count',
//             data: data.map(entry => entry.attendance_count),
//             borderColor: 'rgba(75, 192, 192, 1)',
//             borderWidth: 2,
//             fill: false
//         }
//     ];

//     const options = {
//         responsive: false,
//         maintainAspectRatio: false,
//         scales: {
//             x: {
//                 title: {
//                     display: true,
//                     text: 'Time'
//                 },
//                 type: 'category',
//                 labels: Array.from({ length: 24 }, (_, i) => `${(i % 12 || 12)} ${i >= 12 ? 'PM' : 'AM'}`),
//                 beginAtZero: true
//             },
//             y: {
//                 title: {
//                     display: true,
//                     text: 'Attendance Count'
//                 },
//                 beginAtZero: true
//             }
//         }
//     };

//     const config = {
//         type: 'line',
//         data: {
//             labels: formattedTimes,
//             datasets: datasets
//         },
//         options: options
//     };

//     // Create or update the chart
//     if (window.AttendanceChart && typeof window.AttendanceChart.destroy === 'function') {
//         window.AttendanceChart.destroy();
//     }

//     window.AttendanceChart = new Chart(ctx, config);
// }

            

            // Call the function to render the attendance chart on page load
            renderInitialAttendanceChart(defaultBranch, defaultMonth, defaultYear);


            // Set the selected attribute for the current month in the dropdown
            $('#monthDropdown').val(defaultMonth);

            // Handle branch selection change
            $('#branchDropdown').on('change', function () {
                const selectedBranch = $(this).val();
                const selectedMonth = $('#monthDropdown').val();
                const selectedYear = $('#yearDropdown').val();
                getAttendanceData(selectedBranch, selectedMonth, selectedYear)
                    .then(data => renderAttendanceChart(data))
                    .catch(error => console.error('Error fetching and rendering attendance data:', error));
            });

            // Handle month selection change
            $('#monthDropdown').on('change', function () {
                const selectedMonth = $(this).val();
                const selectedBranch = $('#branchDropdown').val();
                const selectedYear = $('#yearDropdown').val();
                getAttendanceData(selectedBranch, selectedMonth, selectedYear)
                    .then(data => renderAttendanceChart(data))
                    .catch(error => console.error('Error fetching and rendering attendance data:', error));
            });

            // Handle year selection change
            $('#yearDropdown').on('change', function () {
                const selectedYear = $(this).val();
                const selectedBranch = $('#branchDropdown').val();
                const selectedMonth = $('#monthDropdown').val();
                getAttendanceData(selectedBranch, selectedMonth, selectedYear)
                    .then(data => renderAttendanceChart(data))
                    .catch(error => console.error('Error fetching and rendering attendance data:', error));
            });

        });
    </script>

</body>
</html>